{% extends "base.html" %}

{% block title %}SEVA Arogya - Voice Capture{% endblock %}

{% block content %}
<div class="relative flex h-screen max-w-md mx-auto flex-col bg-white dark:bg-background-dark overflow-hidden shadow-2xl">
    <!-- Header / Status Bar -->
    <div class="flex items-center bg-white dark:bg-background-dark p-4 pb-2 justify-between">
        <div class="flex items-center gap-2">
            <div class="flex size-10 shrink-0 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400">
                <span class="material-symbols-outlined text-[24px] recording-pulse">mic</span>
            </div>
            <div class="flex flex-col">
                <h2 class="text-[#111418] dark:text-white text-sm font-bold leading-tight">Listening...</h2>
                <p id="timer" class="text-xs text-slate-500 dark:text-slate-400">00:00</p>
            </div>
        </div>
        <div class="text-slate-400">
            <span class="material-symbols-outlined">settings</span>
        </div>
    </div>
    
    <!-- Main Transcription Area (Top 2/3) -->
    <div class="flex-1 px-6 pt-8 overflow-y-auto">
        <div id="transcription-display" class="space-y-6">
            <!-- Hidden elements required by TranscriptionController -->
            <button id="start-recording" style="display: none;"></button>
            <button id="stop-recording" style="display: none;"></button>
            <div id="status-indicator" style="display: none;"></div>
            
            <!-- Actual transcription content container -->
            <div id="transcriptionContent" class="space-y-6">
                <!-- Text flow mimicking speech to text -->
                <p class="text-[#111418] dark:text-white tracking-tight text-[30px] font-semibold leading-snug">
                    Ramesh... <span class="text-primary">45 years old</span>... 
                </p>
                <p class="text-[#111418] dark:text-white tracking-tight text-[30px] font-semibold leading-snug">
                    History of <span class="text-primary">fever for 3 days</span>... 
                </p>
                <p class="text-[#111418] dark:text-white tracking-tight text-[30px] font-semibold leading-snug">
                    Patient reports <span class="bg-primary/10 border-b-2 border-primary">sharp pain in lower abdomen</span>, localized to the right...
                </p>
                <!-- Real-time cursor effect -->
                <div class="inline-block w-1 h-8 bg-primary animate-pulse ml-1 align-middle"></div>
            </div>
        </div>
    </div>
    
    <!-- Smart Suggestions Area (Bottom 1/3) -->
    <div class="bg-slate-50 dark:bg-slate-900/50 border-t border-slate-200 dark:border-slate-800 pt-6 pb-8">
        <div class="flex items-center justify-between px-4 mb-3">
            <h3 class="text-[#111418] dark:text-slate-200 text-xs font-bold leading-tight tracking-wider uppercase">Smart Suggestions</h3>
            <span class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full font-bold">AI ACTIVE</span>
        </div>
        
        <!-- Suggestion Pills Carousel -->
        <div class="flex gap-3 px-4 overflow-x-auto no-scrollbar pb-4">
            <button class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 pl-3 pr-4 shadow-sm hover:border-primary active:scale-95 transition-all">
                <span class="material-symbols-outlined text-primary text-[20px]">add</span>
                <p class="text-[#111418] dark:text-white text-sm font-medium">Paracetamol 500mg</p>
            </button>
            
            <button class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 pl-3 pr-4 shadow-sm hover:border-primary active:scale-95 transition-all">
                <span class="material-symbols-outlined text-primary text-[20px]">add</span>
                <p class="text-[#111418] dark:text-white text-sm font-medium">Amoxicillin</p>
            </button>
            
            <button class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 pl-3 pr-4 shadow-sm hover:border-primary active:scale-95 transition-all">
                <span class="material-symbols-outlined text-primary text-[20px]">add</span>
                <p class="text-[#111418] dark:text-white text-sm font-medium">Blood Test (CBC)</p>
            </button>
            
            <button class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 pl-3 pr-4 shadow-sm hover:border-primary active:scale-95 transition-all">
                <span class="material-symbols-outlined text-primary text-[20px]">add</span>
                <p class="text-[#111418] dark:text-white text-sm font-medium">Follow-up 7 days</p>
            </button>
        </div>
        
        <!-- Action Button -->
        <div class="px-4 mt-2">
            <button onclick="stopAndReview()" class="w-full flex items-center justify-center gap-3 rounded-xl h-14 bg-primary text-white shadow-lg shadow-primary/25 active:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined text-[24px]">stop_circle</span>
                <span class="text-lg font-bold">Stop and Review</span>
            </button>
        </div>
        
        <!-- Home Indicator (iOS style) -->
        <div class="mt-4 flex justify-center">
            <div class="w-32 h-1.5 bg-slate-300 dark:bg-slate-700 rounded-full"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/audio-capture.js') }}"></script>
<script src="{{ url_for('static', filename='js/websocket-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/transcription-display.js') }}"></script>
<script src="{{ url_for('static', filename='js/transcription-controller.js') }}"></script>
<script>
    let seconds = 0;
    let timerInterval;
    let controller;
    
    // Start timer
    function startTimer() {
        timerInterval = setInterval(() => {
            seconds++;
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }, 1000);
    }
    
    // Stop and review
    async function stopAndReview() {
        try {
            // Stop the timer
            clearInterval(timerInterval);
            
            // Stop the controller if it's recording
            if (controller && controller.isRecording) {
                console.log('Stopping transcription controller...');
                await controller.stop();
                console.log('Controller stopped, transcription data saved');
            }
            
            // Navigate to final prescription page
            window.location.href = '/final-prescription';
        } catch (error) {
            console.error('Error stopping transcription:', error);
            // Navigate anyway to avoid blocking the user
            window.location.href = '/final-prescription';
        }
    }
    
    // Initialize TranscriptionController on page load
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Get userId from Flask session
            const userId = '{{ session.user_id }}';
            
            // Clear dummy content from transcription-display div
            const transcriptionDisplay = document.getElementById('transcription-display');
            if (transcriptionDisplay) {
                // Keep only the hidden UI elements, remove dummy content
                const startBtn = document.getElementById('start-recording');
                const stopBtn = document.getElementById('stop-recording');
                const statusInd = document.getElementById('status-indicator');
                
                transcriptionDisplay.innerHTML = '';
                
                // Re-add the hidden elements
                if (startBtn) transcriptionDisplay.appendChild(startBtn);
                if (stopBtn) transcriptionDisplay.appendChild(stopBtn);
                if (statusInd) transcriptionDisplay.appendChild(statusInd);
                
                console.log('Cleared dummy content from transcription-display');
            }
            
            // Create TranscriptionController with configuration
            controller = new TranscriptionController({
                websocketUrl: window.location.origin,
                userId: userId,
                quality: 'medium',
                sampleRate: 16000,
                chunkDurationMs: 250
            });
            
            console.log('TranscriptionController created');
            
            // Initialize the controller
            await controller.initialize();
            console.log('TranscriptionController initialized');
            
            // Start transcription automatically
            await controller.start();
            console.log('Transcription started automatically');

            // Start the timer when recording begins
            startTimer();
            
        } catch (error) {
            console.error('Failed to initialize or start transcription:', error);
            // Stop timer if it was started
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // Display error message to user (avoid duplicate error blocks)
            const transcriptionDisplay = document.getElementById('transcription-display');
            const hasError = transcriptionDisplay?.querySelector?.('.error-message');

            if (controller?.display?.showError && !hasError) {
                controller.display.showError(`Failed to start transcription: ${error.message}`);
            } else if (transcriptionDisplay && !hasError) {
                transcriptionDisplay.insertAdjacentHTML('afterbegin', `
                    <div class="text-red-600 dark:text-red-400 text-lg font-semibold">
                        <p>Failed to start transcription</p>
                        <p class="text-sm mt-2">${error.message}</p>
                        <p class="text-sm mt-2">Please check microphone permissions and try again.</p>
                    </div>
                `);
            }
        }
    });
</script>
{% endblock %}
